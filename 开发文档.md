o shifou # 工程机械油猴插件开发文档

## 项目结构

```
工程机械查询插件/
├── machinery-query.user.js      # 主插件文件
├── extended-database.js         # 扩展数据库
├── advanced-styles.css          # 高级样式
├── 插件使用说明.md              # 用户使用说明
└── 开发文档.md                  # 本文档
```

## 核心功能模块

### 1. 关键词识别系统

**智能匹配算法**
- 正则表达式模式匹配
- 品牌+型号+吨位多维识别
- 模糊匹配和别名处理
- 上下文语义分析

**支持的关键词格式**
```javascript
// 标准型号
XCT25, XCT50, STC250T, QY25V

// 描述性关键词  
25吨汽车吊, 50吨起重机, 徐工25吨

// 模糊匹配
25T吊车, 汽车吊25吨, 三一重工25T
```

### 2. 数据管理系统

**内置数据库结构**
```javascript
const machineryDatabase = {
    'DEVICE_CODE': {
        name: '设备全称',
        params: {}, // 技术参数
        newPrice: {}, // 新机价格
        usedPrice: [], // 二手价格
        rentPrice: {} // 租赁价格
    }
}
```

**缓存机制**
- 7天本地存储缓存
- 自动过期检查
- 手动刷新功能
- 数据版本管理

### 3. 用户界面系统

**弹窗组件**
- 拖拽移动功能
- 章节折叠展开
- 响应式设计
- 主题切换支持

**交互方式**
- 鼠标右键菜单
- 快捷键 Ctrl+Shift+M
- ESC关闭弹窗
- 点击外部关闭

## 技术架构

### 1. 事件监听系统
```javascript
// 文本选择监听
document.addEventListener('mouseup', handleTextSelection);

// 键盘快捷键
document.addEventListener('keydown', handleKeyboardShortcut);

// 右键菜单
document.addEventListener('contextmenu', addContextMenuItem);
```

### 2. 数据查询流程
```
用户选中关键词 → 关键词验证 → 缓存检查 → 数据匹配 → 结果展示
```

### 3. 样式管理
```javascript
// 动态样式注入
GM_addStyle(styles);

// 主题切换
function switchTheme(themeName) {
    // 主题切换逻辑
}
```

## 扩展开发指南

### 1. 添加新设备类型

**步骤一：扩展数据库**
```javascript
// 在 machineryDatabase 中添加新设备
'NEW_DEVICE': {
    name: '新设备名称',
    params: {
        '参数1': '值1',
        '参数2': '值2'
    },
    newPrice: {
        official: '官方价格',
        dealer: '经销商价格',
        source: '价格来源'
    },
    usedPrice: [
        { age: '年份', price: '价格', condition: '状况' }
    ],
    rentPrice: {
        daily: '日租',
        monthly: '月租', 
        yearly: '年租',
        includes: '包含内容'
    }
}
```

**步骤二：更新关键词匹配**
```javascript
// 添加新的匹配规则
const keywordPatterns = [
    /新设备类型匹配规则/i,
    // 现有规则...
];
```

### 2. 接入外部数据源

**API接口调用**
```javascript
// 使用GM_xmlhttpRequest获取外部数据
GM_xmlhttpRequest({
    method: 'GET',
    url: 'https://api.example.com/machinery',
    onload: function(response) {
        const data = JSON.parse(response.responseText);
        processExternalData(data);
    }
});
```

**数据格式标准化**
```javascript
function normalizeExternalData(rawData) {
    return {
        name: rawData.deviceName,
        params: convertParams(rawData.specifications),
        prices: convertPrices(rawData.priceInfo)
    };
}
```

### 3. 自定义样式主题

**创建新主题**
```javascript
const customTheme = {
    primary: '#your-color',
    secondary: '#your-color',
    accent: '#your-color',
    background: '#your-color'
};
```

**动态样式更新**
```javascript
function updateTheme(theme) {
    const style = document.querySelector('#machinery-styles');
    style.textContent = generateThemeCSS(theme);
}
```

## 性能优化策略

### 1. 缓存优化
- 智能缓存策略，频繁查询的设备优先缓存
- 压缩存储，减少内存占用
- 异步数据预加载

### 2. 界面优化
- CSS动画使用transform和opacity
- 虚拟滚动处理大量数据
- 懒加载非关键内容

### 3. 内存管理
- 及时清理事件监听器
- 定期清理过期缓存
- 避免内存泄漏

## API文档

### 核心函数

**searchMachinery(keyword)**
- 参数：关键词字符串
- 返回：无返回值（直接显示弹窗）
- 功能：搜索并显示工程机械信息

**findMatchingMachinery(keyword)**
- 参数：关键词字符串
- 返回：匹配的设备数据对象或null
- 功能：在数据库中查找匹配的设备

**displayMachineryData(data)**
- 参数：设备数据对象
- 返回：无返回值
- 功能：渲染设备信息到弹窗

**toggleSection(headerElement)**
- 参数：章节头部DOM元素
- 返回：无返回值
- 功能：切换章节展开/折叠状态

### 全局变量

**currentPopup**
- 类型：DOM元素
- 描述：当前显示的弹窗元素

**selectedText**
- 类型：字符串
- 描述：用户选中的文本内容

**machineryDatabase**
- 类型：对象
- 描述：内置设备数据库

## 测试用例

### 1. 关键词识别测试
```javascript
// 测试标准型号识别
testKeywordRecognition('XCT25'); // 应返回true
testKeywordRecognition('25吨汽车吊'); // 应返回true
testKeywordRecognition('hello world'); // 应返回false
```

### 2. 数据查询测试
```javascript
// 测试数据查找
const result = findMatchingMachinery('XCT25');
assert(result !== null, '应找到匹配数据');
assert(result.name === '徐工XCT25汽车吊', '名称应匹配');
```

### 3. 界面交互测试
```javascript
// 测试弹窗创建
searchMachinery('XCT25');
assert(document.querySelector('#machinery-info-popup'), '弹窗应存在');
```

## 版本发布流程

### 1. 版本号规则
- 主版本号：重大功能更新
- 次版本号：新功能添加
- 修订号：问题修复

### 2. 更新检查
```javascript
// @updateURL 和 @downloadURL 配置
// @version 版本号更新
```

### 3. 兼容性测试
- Chrome 80+
- Firefox 70+
- Edge 80+
- Safari 13+

## 常见问题解决

### 1. 插件无法加载
**检查项目**
- Tampermonkey是否正确安装
- 脚本是否保存并启用
- 页面是否刷新

### 2. 关键词无法识别
**调试方法**
```javascript
console.log('选中文本:', selectedText);
console.log('匹配结果:', isMachineryKeyword(selectedText));
```

### 3. 数据显示异常
**检查数据格式**
```javascript
console.log('查找结果:', findMatchingMachinery(keyword));
```

## 贡献指南

### 1. 代码规范
- 使用ES6+语法
- 驼峰命名法
- 详细注释
- 统一缩进

### 2. 提交规范
```
feat: 添加新功能
fix: 修复问题
docs: 文档更新
style: 样式调整
refactor: 代码重构
test: 测试相关
```

### 3. 数据贡献
- 验证数据准确性
- 提供数据来源
- 统一数据格式
- 定期更新维护

---

**项目维护者**: Engineering Assistant  
**最后更新**: 2024年12月30日  
**版本**: 1.0.0