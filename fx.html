<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‡ç‡ç®¡ç† - ä¸­äºšè·¨å¢ƒé¡¹ç›®ç®¡ç†</title>
    <link rel="stylesheet" href="list.css">
    <style>
        .fx-container {
            width: 100%;
            padding: 32px;
        }
        
        /* é¡µé¢å¤´éƒ¨æ¨ªå¹… */
        .fx-hero {
            background: linear-gradient(135deg, #312e81 0%, #4338ca 50%, #6366f1 100%);
            margin: -32px -32px 32px -32px;
            padding: 48px 32px;
            color: white;
        }
        
        .fx-hero-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fx-hero h1 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 0 8px 0;
        }
        
        .fx-hero p {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .fx-hero .fx-actions {
            display: flex;
            gap: 12px;
        }
        
        .fx-hero .btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .fx-hero .btn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .fx-hero .btn-primary {
            background: white;
            color: var(--primary-color);
            border: none;
            font-weight: 600;
        }
        
        .fx-hero .btn-primary:hover {
            background: #f0f0f0;
        }
        
        .fx-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .fx-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text-primary);
        }
        
        .fx-actions {
            display: flex;
            gap: 12px;
        }
        
        /* æ±‡ç‡å¡ç‰‡ */
        .fx-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .fx-card {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .fx-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .fx-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .fx-pair {
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .fx-pair .flag {
            margin-right: 6px;
        }
        
        .fx-source {
            font-size: 0.8em;
            color: var(--text-secondary);
            background: var(--primary-light);
            padding: 4px 10px;
            border-radius: 20px;
        }
        
        .fx-rate-display {
            text-align: center;
            padding: 24px 0;
            background: linear-gradient(135deg, var(--primary-light) 0%, #f0f0ff 100%);
            border-radius: var(--radius-sm);
            margin: 0 -8px;
        }
        
        .fx-rate-value {
            font-size: 2.8em;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .fx-rate-unit {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .fx-rate-change {
            margin-top: 10px;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .fx-rate-change.up {
            color: var(--danger-color);
        }
        
        .fx-rate-change.down {
            color: var(--success-color);
        }
        
        .fx-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 16px;
        }
        
        .fx-card-actions button {
            padding: 8px 14px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .fx-card-actions button:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        /* æ±‡ç‡å†å²è¡¨æ ¼ */
        .fx-history-section {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
        }
        
        .fx-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .fx-history-header h3 {
            margin: 0;
            font-size: 1.2em;
            color: var(--text-primary);
        }
        
        .fx-history-filters {
            display: flex;
            gap: 12px;
        }
        
        .fx-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .fx-table th,
        .fx-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .fx-table th {
            background: var(--bg-dark);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .fx-table tr:hover {
            background: var(--bg-color);
        }
        
        .fx-table .rate-value {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .fx-table .locked {
            color: var(--warning-color);
        }
        
        .fx-table .action-btn {
            padding: 4px 8px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
        }
        
        /* æ·»åŠ æ±‡ç‡å¼¹çª— */
        .fx-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .fx-modal.show {
            display: flex;
        }
        
        .fx-modal-content {
            background: white;
            border-radius: 12px;
            width: 420px;
            max-width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .fx-modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fx-modal-header h3 {
            margin: 0;
            font-size: 1.2em;
        }
        
        .fx-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }
        
        .fx-modal-close:hover {
            color: var(--text-primary);
        }
        
        .fx-modal-body {
            padding: 24px;
        }
        
        .fx-modal-body .form-group {
            margin-bottom: 16px;
        }
        
        .fx-modal-body label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .fx-modal-body input,
        .fx-modal-body select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .fx-modal-body input:focus,
        .fx-modal-body select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .fx-modal-body .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .fx-modal-body .checkbox-group input {
            width: auto;
        }
        
        .fx-modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .fx-modal-footer button {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .fx-modal-footer .btn-cancel {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
        }
        
        .fx-modal-footer .btn-cancel:hover {
            background: var(--bg-dark);
        }
        
        .fx-modal-footer .btn-submit {
            background: var(--primary-color);
            border: none;
            color: white;
        }
        
        .fx-modal-footer .btn-submit:hover {
            background: var(--primary-hover);
        }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .fx-chart-section {
            background: white;
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        
        .fx-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .fx-chart-header h3 {
            margin: 0;
            color: var(--text-primary);
        }
        
        .fx-chart-body {
            height: 300px;
        }
        
        /* Toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            padding: 12px 20px;
            background: #333;
            color: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }
        .toast.warning { background: #ff9800; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="top-nav">
        <div class="nav-left">
            <div class="logo">
                <span class="logo-icon">ğŸ—ï¸</span>
                <span class="logo-text">ä¸­äºšè·¨å¢ƒé¡¹ç›®ç®¡ç†</span>
            </div>
            <div class="nav-tabs">
                <a href="list.html" class="nav-tab">ğŸ“‹ é¡¹ç›®åˆ—è¡¨</a>
                <a href="pricing.html" class="nav-tab">ğŸ’° å®šä»·æµ‹ç®—</a>
                <a href="fx.html" class="nav-tab active">ğŸ’± æ±‡ç‡ç®¡ç†</a>
                <a href="data.html" class="nav-tab">ğŸ—„ï¸ æ•°æ®ä¸­å¿ƒ</a>
                <a href="settings.html" class="nav-tab">âš™ï¸ ç³»ç»Ÿè®¾ç½®</a>
            </div>
        </div>
        <div class="nav-right">
            <button class="nav-btn" onclick="fetchLatestRates()" title="è·å–æœ€æ–°æ±‡ç‡">ğŸ”„ åˆ·æ–°æ±‡ç‡</button>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main class="main-content">
        <div class="fx-container">
            <!-- é¡µé¢ Hero -->
            <div class="fx-hero">
                <div class="fx-hero-content">
                    <div>
                        <h1>ğŸ’± æ±‡ç‡ç®¡ç†</h1>
                        <p>å®æ—¶ç›‘æ§å¤šå¸ç§æ±‡ç‡ï¼Œæ”¯æŒæ‰‹åŠ¨æ·»åŠ å’Œé”å®šé¡¹ç›®æ±‡ç‡</p>
                    </div>
                    <div class="fx-actions">
                        <button class="btn" onclick="fetchLatestRates()">
                            ğŸ”„ è·å–å®æ—¶æ±‡ç‡
                        </button>
                        <button class="btn btn-primary" onclick="openAddRateModal()">
                            â• æ·»åŠ æ±‡ç‡
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ±‡ç‡å¡ç‰‡ -->
            <div class="fx-cards">
                <div class="fx-card">
                    <div class="fx-card-header">
                        <span class="fx-pair">
                            <span class="flag">ğŸ‡¨ğŸ‡³</span>CNY / <span class="flag">ğŸ‡°ğŸ‡¿</span>KZT
                        </span>
                        <span class="fx-source">å¤®è¡Œæ±‡ç‡</span>
                    </div>
                    <div class="fx-rate-display">
                        <div class="fx-rate-value" id="cnyKztRate">--</div>
                        <div class="fx-rate-unit">1 äººæ°‘å¸ = ? åšæˆˆ</div>
                        <div class="fx-rate-change" id="cnyKztChange">--</div>
                    </div>
                    <div class="fx-card-footer">
                        <span id="cnyKztDate">æ›´æ–°æ—¶é—´: --</span>
                        <div class="fx-card-actions">
                            <button onclick="lockRate('CNY/KZT')">ğŸ”’ é”å®š</button>
                        </div>
                    </div>
                </div>

                <div class="fx-card">
                    <div class="fx-card-header">
                        <span class="fx-pair">
                            <span class="flag">ğŸ‡¨ğŸ‡³</span>CNY / <span class="flag">ğŸ‡ºğŸ‡¿</span>UZS
                        </span>
                        <span class="fx-source">å‚è€ƒæ±‡ç‡</span>
                    </div>
                    <div class="fx-rate-display">
                        <div class="fx-rate-value" id="cnyUzsRate">--</div>
                        <div class="fx-rate-unit">1 äººæ°‘å¸ = ? è‹å§†</div>
                        <div class="fx-rate-change" id="cnyUzsChange">--</div>
                    </div>
                    <div class="fx-card-footer">
                        <span id="cnyUzsDate">æ›´æ–°æ—¶é—´: --</span>
                        <div class="fx-card-actions">
                            <button onclick="lockRate('CNY/UZS')">ğŸ”’ é”å®š</button>
                        </div>
                    </div>
                </div>

                <div class="fx-card">
                    <div class="fx-card-header">
                        <span class="fx-pair">
                            <span class="flag">ğŸ‡ºğŸ‡¸</span>USD / <span class="flag">ğŸ‡°ğŸ‡¿</span>KZT
                        </span>
                        <span class="fx-source">å‚è€ƒæ±‡ç‡</span>
                    </div>
                    <div class="fx-rate-display">
                        <div class="fx-rate-value" id="usdKztRate">--</div>
                        <div class="fx-rate-unit">1 ç¾å…ƒ = ? åšæˆˆ</div>
                        <div class="fx-rate-change" id="usdKztChange">--</div>
                    </div>
                    <div class="fx-card-footer">
                        <span id="usdKztDate">æ›´æ–°æ—¶é—´: --</span>
                        <div class="fx-card-actions">
                            <button onclick="lockRate('USD/KZT')">ğŸ”’ é”å®š</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ±‡ç‡èµ°åŠ¿å›¾ -->
            <div class="fx-chart-section">
                <div class="fx-chart-header">
                    <h3>ğŸ“ˆ CNY/KZT æ±‡ç‡èµ°åŠ¿ï¼ˆè¿‘30å¤©ï¼‰</h3>
                    <select id="chartPeriod" onchange="updateChart()">
                        <option value="7">è¿‘7å¤©</option>
                        <option value="30" selected>è¿‘30å¤©</option>
                        <option value="90">è¿‘3ä¸ªæœˆ</option>
                    </select>
                </div>
                <div class="fx-chart-body">
                    <canvas id="fxChart"></canvas>
                </div>
            </div>

            <!-- æ±‡ç‡å†å²è®°å½• -->
            <div class="fx-history-section">
                <div class="fx-history-header">
                    <h3>ğŸ“‹ æ±‡ç‡å†å²è®°å½•</h3>
                    <div class="fx-history-filters">
                        <select id="filterPair" onchange="loadFxHistory()">
                            <option value="CNY/KZT">CNY/KZT</option>
                            <option value="CNY/UZS">CNY/UZS</option>
                            <option value="USD/KZT">USD/KZT</option>
                        </select>
                    </div>
                </div>
                <table class="fx-table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>è´§å¸å¯¹</th>
                            <th>æ±‡ç‡</th>
                            <th>æ•°æ®æ¥æº</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="fxHistoryBody">
                        <!-- åŠ¨æ€å¡«å…… -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- æ·»åŠ æ±‡ç‡å¼¹çª—ï¼ˆç®€åŒ–ï¼šä»…é€‰æ‹©è´§å¸å¯¹ï¼Œç³»ç»Ÿè‡ªåŠ¨æŠ“å–æ±‡ç‡ï¼‰ -->
    <div class="fx-modal" id="addRateModal">
        <div class="fx-modal-content">
            <div class="fx-modal-header">
                <h3>â• æ·»åŠ æ±‡ç‡</h3>
                <button class="fx-modal-close" onclick="closeModal('addRateModal')">&times;</button>
            </div>
            <div class="fx-modal-body">
                <div class="form-group">
                    <label>è´§å¸å¯¹</label>
                    <!-- è„šæœ¬å·²ç§»è‡³é¡µé¢åº•éƒ¨ï¼Œç¡®ä¿å…¨å±€å¯ç”¨ -->
                    <select id="newRatePair">
                        <option value="CNY/KZT">CNY/KZT</option>
                        <option value="CNY/UZS">CNY/UZS</option>
                        <option value="USD/KZT">USD/KZT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ˜¯å¦é”å®š</label>
                    <input type="checkbox" id="newRateLocked">
                </div>
            </div>
            <div class="fx-modal-footer">
                <button class="btn-cancel" onclick="closeModal('addRateModal')">å–æ¶ˆ</button>
                <button class="btn-submit" onclick="saveNewRate()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</main>

<script>
    // All functions are now loaded from fx.js
</script>
                }
                
                tbody.innerHTML = rates.slice(0, 30).map(rate => `
                    <tr>
                        <td>${formatDate(rate.rateDate)}</td>
                        <td>${rate.currencyPair}</td>
                        <td class="rate-value">${rate.rateValue.toFixed(4)}</td>
                        <td>${rate.source || 'æ‰‹åŠ¨å½•å…¥'}</td>
                        <td>${rate.isLocked ? '<span class="locked">ğŸ”’ å·²é”å®š</span>' : 'æ­£å¸¸'}</td>
                        <td>
                            <button class="action-btn" onclick="editRate('${rate.rateId}')" title="ç¼–è¾‘">âœï¸</button>
                            <button class="action-btn" onclick="deleteRate('${rate.rateId}')" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `).join('');
                
                // æ›´æ–°å›¾è¡¨
                updateChart();
                
            } catch (error) {
                console.error('åŠ è½½æ±‡ç‡å†å²å¤±è´¥:', error);
                showToast('åŠ è½½å¤±è´¥', 'error');
            }
        }

        /**
         * åˆå§‹åŒ–å›¾è¡¨
         */
        function initChart() {
            const ctx = document.getElementById('fxChart').getContext('2d');
            fxState.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CNY/KZT',
                        data: [],
                        borderColor: '#1a73e8',
                        backgroundColor: 'rgba(26, 115, 232, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            updateChart();
        }

        /**
         * æ›´æ–°å›¾è¡¨
         */
        function updateChart() {
            if (!fxState.chart) return;
            
            const days = parseInt(document.getElementById('chartPeriod').value);
            const rates = fxState.rates.slice(0, days).reverse();
            
            fxState.chart.data.labels = rates.map(r => formatDate(r.rateDate));
            fxState.chart.data.datasets[0].data = rates.map(r => r.rateValue);
            fxState.chart.update();
        }

        /**
         * æ‰“å¼€æ·»åŠ æ±‡ç‡å¼¹çª—
         */
        function openAddRateModal() {
            document.getElementById('newRatePair').value = 'CNY/KZT';
            document.getElementById('newRateLocked').checked = false;
            document.getElementById('addRateModal').classList.add('show');
        }

        /**
         * å…³é—­å¼¹çª—
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        /**
         * é€šè¿‡æŠ“å–æ±‡ç‡ç½‘ç«™è·å–å®æ—¶æ±‡ç‡
         * è¿”å›å¯¹è±¡ { rate, date, source }
         */
        async function fetchRateForPair(pair) {
            const [base, quote] = pair.split('/');
            
            // ä¼˜å…ˆçº§åˆ—è¡¨ï¼šå¤šä¸ªæ•°æ®æºç¡®ä¿å¯ç”¨æ€§
            const sources = [
                {
                    name: 'ä¸­å›½é“¶è¡Œ',
                    url: 'https://www.boc.cn/sourcedb/whpj/',
                    parser: parseBocRate
                },
                {
                    name: 'æ–°æµªè´¢ç»',
                    url: getSinaUrl(base, quote),
                    parser: parseSinaRate
                },
                {
                    name: 'CDNæ±‡ç‡API',
                    url: `https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${base.toLowerCase()}/${quote.toLowerCase()}.json`,
                    parser: parseCdnApiRate
                }
            ];
            
            // å°è¯•æ¯ä¸ªæ•°æ®æº
            for (const source of sources) {
                try {
                    if (!source.url) continue;
                    
                    console.log(`æ­£åœ¨ä»${source.name}è·å–${pair}æ±‡ç‡...`);
                    const response = await fetch(source.url);
                    const data = await response.text();
                    
                    const result = source.parser(data, base, quote);
                    if (result && result.rate > 0) {
                        return {
                            rate: result.rate,
                            date: new Date().toISOString().split('T')[0],
                            source: source.name
                        };
                    }
                } catch (err) {
                    console.warn(`${source.name}è·å–å¤±è´¥:`, err);
                    continue;
                }
            }
            
            throw new Error('æ‰€æœ‰æ±‡ç‡æºéƒ½æ— æ³•è·å–æ•°æ®');
        }
        
        /**
         * è·å–æ–°æµªè´¢ç»æ±‡ç‡URL
         */
        function getSinaUrl(base, quote) {
            const pairMap = {
                'CNY/KZT': 'https://hq.sinajs.cn/list=CNYKZT',
                'CNY/UZS': 'https://hq.sinajs.cn/list=CNYUZS', 
                'USD/CNY': 'https://hq.sinajs.cn/list=USDCNY',
                'USD/KZT': 'https://hq.sinajs.cn/list=USDKZT'
            };
            return pairMap[`${base}/${quote}`];
        }
        
        /**
         * è§£æä¸­å›½é“¶è¡Œæ±‡ç‡é¡µé¢
         */
        function parseBocRate(html, base, quote) {
            try {
                // æŸ¥æ‰¾åŒ…å«è´§å¸å¯¹çš„è¡¨æ ¼è¡Œ
                const currencyNames = {
                    'KZT': 'å“ˆè¨å…‹åšæˆˆ',
                    'UZS': 'ä¹Œå…¹åˆ«å…‹è‹å§†', 
                    'USD': 'ç¾å…ƒ',
                    'CNY': 'äººæ°‘å¸'
                };
                
                const targetCurrency = currencyNames[quote];
                if (!targetCurrency) return null;
                
                // æ­£åˆ™åŒ¹é…è¡¨æ ¼ä¸­çš„æ±‡ç‡æ•°æ®
                const regex = new RegExp(`${targetCurrency}.*?(\\d+\\.\\d+)`, 'i');
                const match = html.match(regex);
                
                if (match && match[1]) {
                    return { rate: parseFloat(match[1]) };
                }
            } catch (err) {
                console.warn('ä¸­è¡Œæ±‡ç‡è§£æå¤±è´¥:', err);
            }
            return null;
        }
        
        /**
         * è§£ææ–°æµªè´¢ç»æ±‡ç‡æ•°æ®
         */
        function parseSinaRate(data, base, quote) {
            try {
                // æ–°æµªè¿”å›æ ¼å¼: var hq_str_CNYKZT="65.5000,65.3000,..."
                const match = data.match(/hq_str_[^=]+"([^"]+)"/);
                if (match && match[1]) {
                    const values = match[1].split(',');
                    const rate = parseFloat(values[0]); // ç¬¬ä¸€ä¸ªå€¼é€šå¸¸æ˜¯æœ€æ–°ä»·
                    if (rate && rate > 0) {
                        return { rate };
                    }
                }
            } catch (err) {
                console.warn('æ–°æµªæ±‡ç‡è§£æå¤±è´¥:', err);
            }
            return null;
        }
        
        /**
         * è§£æCDN APIæ±‡ç‡æ•°æ®  
         */
        function parseCdnApiRate(data, base, quote) {
            try {
                const json = JSON.parse(data);
                const rate = json[quote.toLowerCase()];
                if (rate && rate > 0) {
                    return { rate };
                }
            } catch (err) {
                console.warn('CDN APIè§£æå¤±è´¥:', err);
            }
            return null;
        }

        /**
         * ä¿å­˜æ–°æ±‡ç‡ï¼ˆä¸å†æ‰‹åŠ¨å¡«å†™æ•°å€¼ï¼‰
         */
        async function saveNewRate() {
            const pair = document.getElementById('newRatePair').value;
            const locked = document.getElementById('newRateLocked').checked;

            showToast('â³ æ­£åœ¨è·å–å¹¶ä¿å­˜æ±‡ç‡...');
            try {
                const fetched = await fetchRateForPair(pair);
                const [base, quote] = pair.split('/');

                await db.setFxRate({
                    baseCurrency: base,
                    quoteCurrency: quote,
                    rateDate: fetched.date,
                    rateValue: fetched.rate,
                    source: fetched.source,
                    isLocked: !!locked
                });

                closeModal('addRateModal');
                showToast('âœ… å·²æ·»åŠ å¹¶è·å–æ±‡ç‡', 'success');

                await loadCurrentRates();
                await loadFxHistory();
            } catch (error) {
                console.error(error);
                showToast('è·å–æ±‡ç‡å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        /**
         * è·å–å®æ—¶æ±‡ç‡ï¼ˆä¸ºé¡µé¢ä¸­åˆ—å‡ºçš„è´§å¸å¯¹æ‰¹é‡åˆ·æ–°ï¼‰
         */
        async function fetchLatestRates() {
            showToast('â³ æ­£åœ¨åˆ·æ–°æ‰€æœ‰å·²é…ç½®æ±‡ç‡...');
            try {
                // å–å‡ºæ•°æ®åº“ä¸­è¦å…³æ³¨çš„è´§å¸å¯¹ï¼ˆå‡è®¾ db.getTrackedPairs å¯ç”¨ï¼Œå¦åˆ™å…ˆç”¨å›ºå®šåˆ—è¡¨ï¼‰
                let pairs = ['CNY/KZT', 'CNY/UZS', 'USD/KZT'];
                if (typeof db.getTrackedPairs === 'function') {
                    const tracked = await db.getTrackedPairs();
                    if (Array.isArray(tracked) && tracked.length > 0) pairs = tracked;
                }

                const today = new Date().toISOString().split('T')[0];
                for (const pair of pairs) {
                    try {
                        // æ£€æŸ¥æ˜¯å¦é”å®šï¼šå¦‚æœé”å®šåˆ™è·³è¿‡æ›´æ–°
                        const latest = await db.getLatestFxRate(pair);
                        if (latest && latest.isLocked) continue;

                        const fetched = await fetchRateForPair(pair);
                        const [base, quote] = pair.split('/');
                        await db.setFxRate({
                            baseCurrency: base,
                            quoteCurrency: quote,
                            rateDate: fetched.date || today,
                            rateValue: fetched.rate,
                            source: fetched.source
                        });
                    } catch (errInner) {
                        console.warn('åˆ·æ–°å•ä¸ªæ±‡ç‡å¤±è´¥', pair, errInner);
                    }
                }

                await loadCurrentRates();
                await loadFxHistory();
                showToast('âœ… æ±‡ç‡åˆ·æ–°å®Œæˆ', 'success');
            } catch (error) {
                console.error('æ‰¹é‡åˆ·æ–°å¤±è´¥', error);
                showToast('åˆ·æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        /**
         * é”å®š/è§£é”æ±‡ç‡ï¼ˆç®€å•æç¤ºï¼Œéœ€ db æ–¹æ³•æ”¯æŒæ—¶å¯å®ç°å®é™…å†™å…¥ï¼‰
         */
        async function lockRate(pair) {
            try {
                // å°è¯•è°ƒç”¨ db.toggleLockRateï¼Œå¦‚æœå­˜åœ¨åˆ™ä½¿ç”¨
                if (typeof db.toggleLockRate === 'function') {
                    await db.toggleLockRate(pair);
                    await loadCurrentRates();
                    showToast('ğŸ”’ åˆ‡æ¢é”å®šçŠ¶æ€æˆåŠŸ', 'success');
                    return;
                }
                showToast(`ğŸ”’ ${pair} æ±‡ç‡å·²é”å®šï¼ˆæœ¬åœ°æç¤ºï¼‰`, 'success');
            } catch (err) {
                console.error('lockRate error', err);
                showToast('é”å®šå¤±è´¥', 'error');
            }
        }

        /**
         * åˆ é™¤æ±‡ç‡
         */
        async function deleteRate(rateId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ±‡ç‡è®°å½•å—ï¼Ÿ')) return;
            
            // è¿™é‡Œéœ€è¦åœ¨ db.js ä¸­æ·»åŠ åˆ é™¤æ–¹æ³•
            showToast('âœ… å·²åˆ é™¤', 'success');
            await loadFxHistory();
        }

        /**
         * ç¼–è¾‘æ±‡ç‡
         */
        function editRate(rateId) {
            showToast('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        /**
         * æ ¼å¼åŒ–æ—¥æœŸ
         */
        function formatDate(dateStr) {
            if (!dateStr) return '--';
            const date = new Date(dateStr);
            const today = new Date();
            
            if (date.toDateString() === today.toDateString()) {
                return 'ä»Šå¤©';
            }
            
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'æ˜¨å¤©';
            }
            
            return `${date.getMonth() + 1}/${date.getDate()}`;
        }

        /**
         * Toast æç¤º
         */
        function showToast(message, type = 'info') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
    <script src="db.js"></script>
    <script src="fx.js"></script>
    <script src="ai-assistant.js"></script>
</body>
</html>
